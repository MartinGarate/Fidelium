<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Fidelium - Gesti√≥n Inteligente</title>
    <base href="/" />
    <link rel="stylesheet" href="css/bootstrap/bootstrap.min.css" />
    <link rel="stylesheet" href="css/app.css" />
    <link rel="icon" type="image/png" href="favicon.png" />
    <link href="WebBlazor.styles.css" rel="stylesheet" />
    <link href="_content/Radzen.Blazor/css/default-base.css" rel="stylesheet" />
    <link href="_content/Radzen.Blazor/css/default.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
</head>

<body>
    <div id="app">
        <svg class="loading-progress">
            <circle r="40%" cx="50%" cy="50%" />
            <circle r="40%" cx="50%" cy="50%" />
        </svg>
        <div class="loading-progress-text"></div>

        <!-- Informaci√≥n adicional durante la carga -->
        <div class="loading-info">
            <h2>Fidelium</h2>
            <p>Cargando tu plataforma de gesti√≥n...</p>
            <p><small>Esto puede tomar unos momentos</small></p>
        </div>
    </div>

    <div id="blazor-error-ui">
        <i class="fas fa-exclamation-triangle" style="margin-right: 0.5rem;"></i>
        Ha ocurrido un error no controlado.
        <a href="" class="reload">Recargar</a>
        <a class="dismiss">üóô</a>
    </div>

    <!-- Scripts de Firebase -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>

    <!-- Configuraci√≥n Firebase y funciones auxiliares -->
    <script>
        console.log('üî• Inicializando Firebase...');

        const firebaseConfig = {
            apiKey: "AIzaSyBCPRTKbCRp-OpZIym7mMADGDr705lnMck",
            authDomain: "fidelium-1e400.firebaseapp.com",
            projectId: "fidelium-1e400",
            storageBucket: "fidelium-1e400.firebasestorage.app",
            messagingSenderId: "300056033532",
            appId: "1:300056033532:web:322c3e9089a6cbed2c3f79"
        };

        try {
            firebase.initializeApp(firebaseConfig);
            console.log('‚úÖ Firebase inicializado correctamente');

            window.firebaseAuth = {
                signInWithEmailPassword: async function (email, password) {
                    try {
                        console.log('üîë Intentando login con:', email);
                        const userCredential = await firebase.auth().signInWithEmailAndPassword(email, password);
                        console.log('‚úÖ Login exitoso:', userCredential.user.uid);
                        return userCredential.user;
                    } catch (error) {
                        console.error("‚ùå Error en autenticaci√≥n:", error.message);
                        return null;
                    }
                },
                createUserWithEmailAndPassword: async function (email, password, displayName) {
                    try {
                        console.log('üë§ Creando usuario:', email, displayName);
                        const userCredential = await firebase.auth().createUserWithEmailAndPassword(email, password);
                        const user = userCredential.user;

                        await user.updateProfile({ displayName: displayName });
                        await user.sendEmailVerification();

                        console.log('‚úÖ Usuario creado:', user.uid);
                        return userCredential.user.uid;
                    } catch (error) {
                        console.error("‚ùå Error creando usuario:", error.message);
                        return null;
                    }
                },
                signOut: async function () {
                    try {
                        await firebase.auth().signOut();
                        console.log('‚úÖ Sesi√≥n cerrada');
                    } catch (error) {
                        console.error("‚ùå Error cerrando sesi√≥n:", error.message);
                    }
                }
            };

        } catch (error) {
            console.error('‚ùå Error inicializando Firebase:', error);
        }

        // Helper para localStorage
        window.localStorageHelper = {
            setItem: function (key, value) {
                try {
                    localStorage.setItem(key, value);
                    return true;
                } catch (error) {
                    console.error('‚ùå Error guardando en localStorage:', error);
                    return false;
                }
            },
            getItem: function (key) {
                try {
                    return localStorage.getItem(key);
                } catch (error) {
                    console.error('‚ùå Error leyendo localStorage:', error);
                    return null;
                }
            },
            removeItem: function (key) {
                try {
                    localStorage.removeItem(key);
                    return true;
                } catch (error) {
                    console.error('‚ùå Error removiendo de localStorage:', error);
                    return false;
                }
            }
        };

        // Manejo global de errores
        window.addEventListener('error', function (e) {
            console.error('üö® Error global capturado:', {
                message: e.message,
                filename: e.filename,
                lineno: e.lineno,
                colno: e.colno,
                error: e.error
            });

            // Mostrar un mensaje m√°s descriptivo en el error UI
            const errorUi = document.getElementById('blazor-error-ui');
            if (errorUi) {
                errorUi.innerHTML = `
                    <i class="fas fa-exclamation-triangle" style="margin-right: 0.5rem;"></i>
                    Error durante la carga: ${e.message || 'Error desconocido'}
                    <a href="" class="reload">Recargar</a>
                    <a class="dismiss" onclick="this.parentElement.style.display='none'">üóô</a>
                `;
            }
        });

        // Capturar errores de promesas no manejadas
        window.addEventListener('unhandledrejection', function (e) {
            console.error('üö® Promesa rechazada no manejada:', e.reason);
        });

        // Mostrar progreso de carga
        console.log('üöÄ Iniciando aplicaci√≥n Blazor...');

        // Cuando Blazor termine de cargar
        window.addEventListener('load', function () {
            console.log('üìÑ P√°gina cargada');

            // Verificar que Blazor se cargue en un tiempo razonable
            setTimeout(function () {
                if (document.getElementById('app').innerHTML.includes('loading-progress')) {
                    console.warn('‚ö†Ô∏è Blazor est√° tardando en cargar...');

                    // Actualizar mensaje de carga
                    const loadingText = document.querySelector('.loading-progress-text');
                    if (loadingText) {
                        loadingText.textContent = 'Carga inicial tardando m√°s de lo esperado...';
                    }
                }
            }, 10000); // 10 segundos
        });
    </script>

    <!-- Scripts de librer√≠as -->
    <script src="_content/CurrieTechnologies.Razor.SweetAlert2/sweetAlert2.min.js"></script>

    <!-- Blazor WebAssembly -->
    <script src="_framework/blazor.webassembly.js" autostart="false"></script>

    <!-- Inicializaci√≥n personalizada de Blazor -->
    <script>
        console.log('üîß Configurando Blazor...');

        Blazor.start({
            loadBootResource: function (type, name, defaultUri, integrity) {
                console.log(`üì¶ Cargando recurso: ${type} - ${name}`);
                return defaultUri;
            }
        }).then(() => {
            console.log('‚úÖ Blazor iniciado correctamente');
        }).catch(error => {
            console.error('‚ùå Error iniciando Blazor:', error);

            // Mostrar error m√°s espec√≠fico
            const errorUi = document.getElementById('blazor-error-ui');
            if (errorUi) {
                errorUi.innerHTML = `
                    <i class="fas fa-exclamation-triangle" style="margin-right: 0.5rem;"></i>
                    Error iniciando la aplicaci√≥n: ${error.message || 'Error de inicializaci√≥n'}
                    <a href="" class="reload">Recargar</a>
                    <a class="dismiss" onclick="this.parentElement.style.display='none'">üóô</a>
                `;
                errorUi.style.display = 'block';
            }
        });
    </script>
</body>

</html>