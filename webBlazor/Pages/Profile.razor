@page "/profile"

@using Components
@inject FirebaseAuthService authService
@inject NavigationManager navigationManager

@if (!isAuthenticated)
{
    <div class="settings-container">
        <div class="settings-card">
            <h2>Acceso Denegado</h2>
            <p>Debes iniciar sesión para acceder a configuración.</p>
            <NavLink href="/login" class="btn-primary">Ir a Login</NavLink>
        </div>
    </div>
}
else
{
    <div class="settings-container">
        <div class="settings-card">
            <div class="settings-header">
                <h1>Configuración de Perfil</h1>
                <p class="settings-subtitle">Actualiza tu información personal</p>
            </div>

            @if (!string.IsNullOrEmpty(errorMessage))
            {
                <div class="error-alert">
                    <span class="error-icon">⚠️</span>
                    <span>@errorMessage</span>
                </div>
            }

            @if (!string.IsNullOrEmpty(successMessage))
            {
                <div class="success-alert">
                    <span class="success-icon">✓</span>
                    <span>@successMessage</span>
                </div>
            }

            @if (isLoading)
            {
                <div class="profile-loading-container">
                    <LoadingSpinner IsVisible="true" LoadingText="Cargando tu perfil..." />
                </div>
            }
            else if (usuario != null && cliente != null)
            {
                <form @onsubmit="SaveSettings" class="settings-form">
                    <div class="form-section">
                        <h2 class="section-title">Información del Usuario</h2>

                        <div class="form-group">
                            <label for="user-name" class="form-label">Nombre Completo</label>
                            <input id="user-name"
                                   type="text"
                                   class="form-input"
                                   @bind="usuario.Nombre"
                                   placeholder="Tu nombre"
                                   required />
                        </div>

                        <div class="form-group">
                            <label for="user-email" class="form-label">Correo Electrónico</label>
                            <input id="user-email"
                                   type="email"
                                   class="form-input"
                                   @bind="usuario.Email"
                                   placeholder="tu@email.com"
                                   disabled />
                            <small class="form-helper">El email no puede ser modificado</small>
                        </div>

                        <div class="form-group">
                            <label for="user-dni" class="form-label">DNI</label>
                            <input id="user-dni"
                                   type="text"
                                   class="form-input"
                                   @bind="usuario.DNI"
                                   placeholder="Tu DNI" />
                        </div>
                    </div>

                    <div class="form-section">
                        <h2 class="section-title">Información de Contacto</h2>

                        <div class="form-group">
                            <label for="client-phone" class="form-label">Teléfono</label>
                            <input id="client-phone"
                                   type="tel"
                                   class="form-input"
                                   @bind="cliente.Telefono"
                                   placeholder="+34 123 456 789" />
                            <small class="form-helper">Número de teléfono opcional</small>
                        </div>

                        <div class="form-group">
                            <label for="client-instagram" class="form-label">Instagram</label>
                            <input id="client-instagram"
                                   type="text"
                                   class="form-input"
                                   @bind="cliente.Instagram"
                                   placeholder="tu_usuario" />
                            <small class="form-helper">Tu usuario de Instagram sin el @@</small>
                        </div>
                    </div>

                    <div class="form-actions">
                        <button type="button" class="btn-secondary" @onclick="CancelSettings">
                            Cancelar
                        </button>
                        <button type="submit" class="btn-primary" disabled="@isSaving">
                            @if (isSaving)
                            {
                                <span class="spinner"></span>
                                <span>Guardando...</span>
                            }
                            else
                            {
                                <span>Guardar Cambios</span>
                            }
                        </button>
                    </div>
                </form>
            }
            else
            {
                <div class="error-alert">
                    <span class="error-icon">⚠️</span>
                    <span>@(errorMessage ?? "No se pudieron cargar tus datos. Por favor recarga la página.")</span>
                </div>
            }
        </div>
    </div>
}

@code {
    private bool isAuthenticated = false;
    private bool isLoading = true;
    private bool isSaving = false;
    private string? errorMessage = null;
    private string? successMessage = null;

    private Usuario? usuario = null;
    private Cliente? cliente = null;
    private int usuarioID = 0;

    private readonly string _apiBaseUrl = "https://apifidelium.azurewebsites.net";
    private readonly System.Text.Json.JsonSerializerOptions _jsonOptions = new() { PropertyNameCaseInsensitive = true };
    
    [Inject]
    private HttpClient? Http { get; set; }

    protected override async Task OnInitializedAsync()
    {
        isAuthenticated = await authService.IsUserAuthenticated();

        if (!isAuthenticated)
        {
            navigationManager.NavigateTo("/login");
            return;
        }

        await LoadUserData();
    }

    private async Task LoadUserData()
    {
        try
        {
            isLoading = true;
            errorMessage = null;

            // Obtener datos del usuario autenticado desde Firebase
            var firebaseUser = await authService.GetUserFirebase();
            if (firebaseUser == null || string.IsNullOrEmpty(firebaseUser.Email))
            {
                errorMessage = "No se pudo obtener tus datos de autenticación";
                Console.WriteLine("[Settings] Error: Firebase user is null or email is empty");
                isLoading = false;
                return;
            }

            Console.WriteLine($"[Settings] Firebase User Email: {firebaseUser.Email}");

            try
            {
                // Validar HttpClient
                if (Http == null)
                {
                    errorMessage = "Error: HttpClient no está configurado";
                    Console.WriteLine("[Settings] Error: HttpClient is null");
                    isLoading = false;
                    return;
                }

                // 1. Obtener TODOS los usuarios
                var usuariosUrl = $"{_apiBaseUrl}/api/usuarios";
                Console.WriteLine($"[Settings] Calling: {usuariosUrl}");

                var usuariosResponse = await Http.GetAsync(usuariosUrl);

                if (!usuariosResponse.IsSuccessStatusCode)
                {
                    errorMessage = $"Error al obtener usuarios del servidor: {usuariosResponse.StatusCode}";
                    Console.WriteLine($"[Settings] Error response: {usuariosResponse.StatusCode}");
                    isLoading = false;
                    return;
                }

                var usuariosJson = await usuariosResponse.Content.ReadAsStringAsync();
                Console.WriteLine($"[Settings] Usuarios response length: {usuariosJson.Length}");

                var usuariosList = System.Text.Json.JsonSerializer.Deserialize<List<Usuario>>(usuariosJson, _jsonOptions);

                if (usuariosList == null || usuariosList.Count == 0)
                {
                    errorMessage = "No se encontraron usuarios en la base de datos";
                    Console.WriteLine("[Settings] No users found in database");
                    isLoading = false;
                    return;
                }

                Console.WriteLine($"[Settings] Total users found: {usuariosList.Count}");

                // 2. Buscar el usuario que coincida con el email de Firebase
                usuario = usuariosList.FirstOrDefault(u => u.Email?.Equals(firebaseUser.Email, StringComparison.OrdinalIgnoreCase) == true);

                if (usuario == null)
                {
                    var availableEmails = string.Join(", ", usuariosList.Select(u => u.Email ?? "null"));
                    errorMessage = $"No se encontró perfil para el email: {firebaseUser.Email}";
                    Console.WriteLine($"[Settings] User not found for email: {firebaseUser.Email}. Available: {availableEmails}");
                    isLoading = false;
                    return;
                }

                Console.WriteLine($"[Settings] Usuario encontrado: ID={usuario.ID}, Nombre={usuario.Nombre}, Email={usuario.Email}");

                if (usuario.ID <= 0)
                {
                    errorMessage = "ID de usuario inválido";
                    isLoading = false;
                    return;
                }

                usuarioID = usuario.ID;

                // 3. Obtener TODOS los clientes
                var clientesUrl = $"{_apiBaseUrl}/api/clientes";
                Console.WriteLine($"[Settings] Calling: {clientesUrl}");

                var clientesResponse = await Http.GetAsync(clientesUrl);

                if (!clientesResponse.IsSuccessStatusCode)
                {
                    Console.WriteLine($"[Settings] Error al obtener clientes: {clientesResponse.StatusCode}");
                    cliente = new Cliente { UsuarioID = usuarioID };
                }
                else
                {
                    var clientesJson = await clientesResponse.Content.ReadAsStringAsync();
                    Console.WriteLine($"[Settings] Clientes response length: {clientesJson.Length}");

                    var clientesList = System.Text.Json.JsonSerializer.Deserialize<List<Cliente>>(clientesJson, _jsonOptions);

                    if (clientesList != null && clientesList.Count > 0)
                    {
                        // 4. Buscar el cliente asociado al usuario actual (como en UsuariosView)
                        cliente = clientesList.FirstOrDefault(c => c.UsuarioID == usuarioID && !c.IsDeleted);

                        if (cliente != null)
                        {
                            Console.WriteLine($"[Settings] Cliente cargado: ID={cliente.ID}, Telefono={cliente.Telefono}, Instagram={cliente.Instagram}");
                        }
                        else
                        {
                            Console.WriteLine($"[Settings] No cliente found for usuario {usuarioID}, creating empty");
                            cliente = new Cliente { UsuarioID = usuarioID };
                        }
                    }
                    else
                    {
                        Console.WriteLine("[Settings] No clientes in database, creating empty");
                        cliente = new Cliente { UsuarioID = usuarioID };
                    }
                }

                Console.WriteLine("[Settings] Data loaded successfully");
            }
            catch (HttpRequestException ex)
            {
                errorMessage = $"Error de conexión: {ex.Message}";
                Console.WriteLine($"[Settings] HttpRequestException: {ex.Message}");
            }
            catch (System.Text.Json.JsonException ex)
            {
                errorMessage = $"Error al procesar datos: {ex.Message}";
                Console.WriteLine($"[Settings] JsonException: {ex.Message}");
            }
            catch (Exception ex)
            {
                errorMessage = $"Error inesperado: {ex.Message}";
                Console.WriteLine($"[Settings] Exception: {ex.Message}");
            }
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task SaveSettings()
    {
        errorMessage = null;
        successMessage = null;

        if (usuario == null || string.IsNullOrWhiteSpace(usuario.Nombre))
        {
            errorMessage = "El nombre es requerido";
            return;
        }

        if (usuario.ID <= 0)
        {
            errorMessage = "ID de usuario inválido";
            return;
        }

        if (cliente == null)
        {
            errorMessage = "Error: No hay datos de cliente";
            return;
        }

        isSaving = true;

        try
        {
            if (Http == null)
            {
                errorMessage = "Error: HttpClient no está configurado";
                isSaving = false;
                return;
            }

            // Actualizar usuario
            try
            {
                var usuarioUrl = $"{_apiBaseUrl}/api/usuarios/{usuario.ID}";
                Console.WriteLine($"[Settings Save] Actualizando usuario en: {usuarioUrl}");

                var usuarioResponse = await Http.PutAsJsonAsync(usuarioUrl, usuario);

                if (!usuarioResponse.IsSuccessStatusCode)
                {
                    var errorContent = await usuarioResponse.Content.ReadAsStringAsync();
                    errorMessage = $"Error al actualizar usuario: {usuarioResponse.StatusCode}";
                    Console.WriteLine($"[Settings Save] Error: {errorContent}");
                    isSaving = false;
                    return;
                }

                Console.WriteLine("[Settings Save] Usuario actualizado correctamente");
            }
            catch (HttpRequestException ex)
            {
                errorMessage = $"Error de conexión al actualizar usuario: {ex.Message}";
                Console.WriteLine($"[Settings Save] HttpRequestException: {ex.Message}");
                isSaving = false;
                return;
            }

            // Actualizar cliente
            try
            {
                cliente.UsuarioID = usuarioID;
                HttpResponseMessage clienteResponse;

                if (cliente.ID > 0)
                {
                    // Actualizar cliente existente
                    var clienteUrl = $"{_apiBaseUrl}/api/clientes/{cliente.ID}";
                    Console.WriteLine($"[Settings Save] Actualizando cliente en: {clienteUrl}");
                    clienteResponse = await Http.PutAsJsonAsync(clienteUrl, cliente);
                }
                else
                {
                    // Crear cliente nuevo
                    var clienteUrl = $"{_apiBaseUrl}/api/clientes";
                    Console.WriteLine($"[Settings Save] Creando cliente en: {clienteUrl}");
                    clienteResponse = await Http.PostAsJsonAsync(clienteUrl, cliente);

                    if (clienteResponse.IsSuccessStatusCode)
                    {
                        // Obtener el nuevo cliente con el ID asignado
                        var clienteJson = await clienteResponse.Content.ReadAsStringAsync();
                        var clienteActualizado = System.Text.Json.JsonSerializer.Deserialize<Cliente>(clienteJson, _jsonOptions);
                        if (clienteActualizado != null)
                        {
                            cliente = clienteActualizado;
                            Console.WriteLine($"[Settings Save] Cliente creado con ID: {cliente.ID}");
                        }
                    }
                }

                if (!clienteResponse.IsSuccessStatusCode)
                {
                    var errorContent = await clienteResponse.Content.ReadAsStringAsync();
                    errorMessage = $"Error al guardar datos de contacto: {clienteResponse.StatusCode}";
                    Console.WriteLine($"[Settings Save] Error: {errorContent}");
                    return;
                }

                successMessage = "¡Cambios guardados correctamente!";
                Console.WriteLine("[Settings Save] All changes saved successfully");
                await Task.Delay(2000);
            }
            catch (HttpRequestException ex)
            {
                errorMessage = $"Error de conexión al guardar contacto: {ex.Message}";
                Console.WriteLine($"[Settings Save] HttpRequestException: {ex.Message}");
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Error al guardar: {ex.Message}";
            Console.WriteLine($"[Settings Save] Exception: {ex.Message}");
        }
        finally
        {
            isSaving = false;
        }
    }

    private void CancelSettings()
    {
        navigationManager.NavigateTo("/");
    }
}
