@page "/settings"
@using webBlazor.Services
@using Service.Models
@using System.Net.Http.Json
@inject FirebaseAuthService authService
@inject NavigationManager navigationManager

@if (!isAuthenticated)
{
    <div class="settings-container">
        <div class="settings-card">
            <h2>Acceso Denegado</h2>
            <p>Debes iniciar sesión para acceder a configuración.</p>
            <NavLink href="/login" class="btn-primary">Ir a Login</NavLink>
        </div>
    </div>
}
else
{
    <div class="settings-container">
        <div class="settings-card">
            <div class="settings-header">
                <h1>Configuración de Perfil</h1>
                <p class="settings-subtitle">Actualiza tu información personal</p>
            </div>

            @if (!string.IsNullOrEmpty(errorMessage))
            {
                <div class="error-alert">
                    <span class="error-icon">⚠️</span>
                    <span>@errorMessage</span>
                </div>
            }

            @if (!string.IsNullOrEmpty(successMessage))
            {
                <div class="success-alert">
                    <span class="success-icon">✓</span>
                    <span>@successMessage</span>
                </div>
            }

            @if (isLoading)
            {
                <div class="loading-container">
                    <div class="spinner"></div>
                    <p>Cargando datos...</p>
                </div>
            }
            else if (cliente != null)
            {
                <form @onsubmit="SaveSettings" class="settings-form">
                    <div class="form-section">
                        <h2 class="section-title">Información del Usuario</h2>

                        <div class="form-group">
                            <label for="user-name" class="form-label">Nombre Completo</label>
                            <input id="user-name"
                                   type="text"
                                   class="form-input"
                                   @bind="usuario.Nombre"
                                   placeholder="Tu nombre"
                                   required />
                        </div>

                        <div class="form-group">
                            <label for="user-email" class="form-label">Correo Electrónico</label>
                            <input id="user-email"
                                   type="email"
                                   class="form-input"
                                   @bind="usuario.Email"
                                   placeholder="tu@email.com"
                                   disabled />
                            <small class="form-helper">El email no puede ser modificado</small>
                        </div>

                        @if (!string.IsNullOrEmpty(usuario.DNI))
                        {
                            <div class="form-group">
                                <label for="user-dni" class="form-label">DNI</label>
                                <input id="user-dni"
                                       type="text"
                                       class="form-input"
                                       @bind="usuario.DNI"
                                       placeholder="Tu DNI" />
                            </div>
                        }
                    </div>

                    <div class="form-section">
                        <h2 class="section-title">Información de Contacto</h2>

                        <div class="form-group">
                            <label for="client-phone" class="form-label">Teléfono</label>
                            <input id="client-phone"
                                   type="tel"
                                   class="form-input"
                                   @bind="cliente.Telefono"
                                   placeholder="+34 123 456 789" />
                            <small class="form-helper">Número de teléfono opcional</small>
                        </div>

                        <div class="form-group">
                            <label for="client-instagram" class="form-label">Instagram</label>
                            <input id="client-instagram"
                                   type="text"
                                   class="form-input"
                                   @bind="cliente.Instagram"
                                   placeholder="tu_usuario" />
                            <small class="form-helper">Tu usuario de Instagram sin el @@</small>
                        </div>
                    </div>

                    <div class="form-actions">
                        <button type="button" class="btn-secondary" @onclick="CancelSettings">
                            Cancelar
                        </button>
                        <button type="submit" class="btn-primary" disabled="@isSaving">
                            @if (isSaving)
                            {
                                <span class="spinner"></span>
                                <span>Guardando...</span>
                            }
                            else
                            {
                                <span>Guardar Cambios</span>
                            }
                        </button>
                    </div>
                </form>
            }
            else
            {
                <div class="error-alert">
                    <span class="error-icon">⚠️</span>
                    <span>No se pudieron cargar tus datos. Por favor recarga la página.</span>
                </div>
            }
        </div>
    </div>
}

@code {
    private bool isAuthenticated = false;
    private bool isLoading = true;
    private bool isSaving = false;
    private string errorMessage = "";
    private string successMessage = "";

    private Usuario usuario = new();
    private Cliente cliente = new();
    private int usuarioID = 0;

    private readonly string _apiBaseUrl = "https://apifidelium.azurewebsites.net";
    private readonly System.Text.Json.JsonSerializerOptions _jsonOptions = new() { PropertyNameCaseInsensitive = true };

    protected override async Task OnInitializedAsync()
    {
        isAuthenticated = await authService.IsUserAuthenticated();

        if (!isAuthenticated)
        {
            navigationManager.NavigateTo("/login");
            return;
        }

        await LoadUserData();
    }

    private async Task LoadUserData()
    {
        try
        {
            isLoading = true;

            // Obtener datos del usuario autenticado desde Firebase
            var firebaseUser = await authService.GetUserFirebase();
            if (firebaseUser == null || string.IsNullOrEmpty(firebaseUser.Email))
            {
                errorMessage = "No se pudo obtener tus datos de autenticación";
                isLoading = false;
                return;
            }

            // Obtener datos del usuario desde la BD
            using (var httpClient = new HttpClient())
            {
                try
                {
                    // Buscar usuario por email - Usando GetFromJsonAsync
                    var usuarios = await httpClient.GetFromJsonAsync<List<Usuario>>(
                        $"{_apiBaseUrl}/api/usuarios",
                        _jsonOptions);

                    usuario = usuarios?.FirstOrDefault(u => u.Email == firebaseUser.Email) ?? new Usuario();

                    if (usuario?.ID > 0)
                    {
                        usuarioID = usuario.ID;

                        // Obtener datos del cliente por UsuarioID - Usando GetFromJsonAsync
                        try
                        {
                            cliente = await httpClient.GetFromJsonAsync<Cliente>(
                                $"{_apiBaseUrl}/api/clientes/usuario/{usuarioID}",
                                _jsonOptions) ?? new Cliente { UsuarioID = usuarioID };
                        }
                        catch (HttpRequestException)
                        {
                            // Si no existe cliente, crear uno vacío
                            cliente = new Cliente { UsuarioID = usuarioID };
                        }
                    }
                    else
                    {
                        errorMessage = "No se encontró tu perfil de usuario";
                    }
                }
                catch (HttpRequestException ex)
                {
                    errorMessage = $"Error de conexión: {ex.Message}";
                }
                catch (System.Text.Json.JsonException ex)
                {
                    errorMessage = $"Error al procesar datos: {ex.Message}";
                }
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Error al cargar datos: {ex.Message}";
            Console.WriteLine($"Error: {ex}");
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task SaveSettings()
    {
        errorMessage = "";
        successMessage = "";

        if (string.IsNullOrWhiteSpace(usuario?.Nombre))
        {
            errorMessage = "El nombre es requerido";
            return;
        }

        isSaving = true;

        try
        {
            using (var httpClient = new HttpClient())
            {
                // Actualizar usuario - Usando PutAsJsonAsync
                try
                {
                    var usuarioResponse = await httpClient.PutAsJsonAsync(
                        $"{_apiBaseUrl}/api/usuarios/{usuario!.ID}",
                        usuario);

                    if (!usuarioResponse.IsSuccessStatusCode)
                    {
                        var errorContent = await usuarioResponse.Content.ReadAsStringAsync();
                        errorMessage = $"Error al actualizar usuario: {usuarioResponse.StatusCode}";
                        isSaving = false;
                        return;
                    }
                }
                catch (HttpRequestException ex)
                {
                    errorMessage = $"Error de conexión al actualizar usuario: {ex.Message}";
                    isSaving = false;
                    return;
                }

                // Actualizar cliente - Usando PutAsJsonAsync o PostAsJsonAsync
                try
                {
                    cliente.UsuarioID = usuarioID;

                    HttpResponseMessage clienteResponse;

                    if (cliente.ID > 0)
                    {
                        // Actualizar cliente existente
                        clienteResponse = await httpClient.PutAsJsonAsync(
                            $"{_apiBaseUrl}/api/clientes/{cliente.ID}",
                            cliente);
                    }
                    else
                    {
                        // Crear cliente nuevo
                        clienteResponse = await httpClient.PostAsJsonAsync(
                            $"{_apiBaseUrl}/api/clientes",
                            cliente);
                    }

                    if (!clienteResponse.IsSuccessStatusCode)
                    {
                        var errorContent = await clienteResponse.Content.ReadAsStringAsync();
                        errorMessage = $"Error al guardar datos de contacto: {clienteResponse.StatusCode}";
                        return;
                    }

                    // Deserializar la respuesta
                    var clienteJson = await clienteResponse.Content.ReadAsStringAsync();
                    var clienteActualizado = System.Text.Json.JsonSerializer.Deserialize<Cliente>(clienteJson, _jsonOptions);
                    if (clienteActualizado != null)
                    {
                        cliente = clienteActualizado;
                    }

                    successMessage = "¡Cambios guardados correctamente!";
                    await Task.Delay(2000);
                    StateHasChanged();
                }
                catch (HttpRequestException ex)
                {
                    errorMessage = $"Error de conexión al guardar contacto: {ex.Message}";
                }
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Error al guardar: {ex.Message}";
            Console.WriteLine($"Error: {ex}");
        }
        finally
        {
            isSaving = false;
        }
    }

    private void CancelSettings()
    {
        navigationManager.NavigateTo("/");
    }
}
