@page "/compras"
@inject FirebaseAuthService authService
@inject NavigationManager navigationManager
@inject IGenericService<Usuario> usuarioService
@inject IGenericService<Cliente> clienteService
@inject IGenericService<CompraServicio> compraService
@inject IGenericService<Notificacion> notificacionService

@using Service.Enums
@using Service.Models

<div class="compras-container">
    <div class="compras-card">
        @if (!isAuthenticated)
        {
            <div class="access-denied">
                <div class="access-denied-icon">üîí</div>
                <h2>Acceso Restringido</h2>
                <p>Debes iniciar sesi√≥n para ver tu historial de compras.</p>
                <NavLink href="/login" class="btn-primary">
                    üöÄ Iniciar Sesi√≥n
                </NavLink>
            </div>
        }
        else
        {
            <div class="compras-header">
                <div class="header-content">
                    <h1 class="page-title">
                        <span class="title-icon">üõçÔ∏è</span>
                        Mis Compras & Servicios
                    </h1>
                    <p class="page-subtitle">Historial de tus compras registradas por nuestro equipo</p>
                    @if (clienteInfo != null && compras.Count > 0)
                    {
                        <div class="client-info">
                            <span class="client-badge">üë§ {clienteInfo.Nombre}</span>
                            <span class="purchases-count">üì¶ {compras.Count} compras</span>
                        </div>
                    }
                </div>
                <div class="header-actions">
                    <NavLink href="/reviews" class="btn-reviews">
                        üí¨ Gestionar Opiniones
                    </NavLink>
                    <button type="button" class="btn-refresh" @onclick="RefreshData" disabled="@isLoading">
                        @if (isLoading)
                        {
                            <span class="spinner-small"></span>
                        }
                        else
                        {
                            <span>üîÑ</span>
                        }
                        Actualizar
                    </button>
                </div>
            </div>

            @if (!string.IsNullOrEmpty(errorMessage))
            {
                <div class="error-section">
                    <div class="error-alert">
                        <span class="error-icon">‚ö†Ô∏è</span>
                        <div class="error-content">
                            <strong>Error</strong>
                            <p>@errorMessage</p>
                        </div>
                        <button class="btn-retry" @onclick="RefreshData">
                            Reintentar
                        </button>
                    </div>
                </div>
            }

            @if (isLoading)
            {
                <div class="loading-section">
                    <div class="loading-spinner">
                        <div class="spinner-ring"></div>
                        <div class="spinner-ring spinner-ring-2"></div>
                        <div class="spinner-ring spinner-ring-3"></div>
                    </div>
                    <h3>Cargando tu historial...</h3>
                    <p>Obteniendo tus compras y servicios</p>
                </div>
            }
            else if (compras.Any())
            {
                <!-- Estad√≠sticas -->
                <div class="stats-section">
                    <div class="stat-card primary">
                        <div class="stat-icon">üìä</div>
                        <div class="stat-content">
                            <span class="stat-number">@compras.Count</span>
                            <span class="stat-label">Total Compras</span>
                        </div>
                    </div>
                    <div class="stat-card success">
                        <div class="stat-icon">üí¨</div>
                        <div class="stat-content">
                            <span class="stat-number">@compras.Count(c => HasValidFeedback(c))</span>
                            <span class="stat-label">Con Opini√≥n</span>
                        </div>
                    </div>
                    <div class="stat-card warning">
                        <div class="stat-icon">‚è≥</div>
                        <div class="stat-content">
                            <span class="stat-number">@compras.Count(c => !HasValidFeedback(c))</span>
                            <span class="stat-label">Sin Opini√≥n</span>
                        </div>
                    </div>
                    <div class="stat-card info">
                        <div class="stat-icon">‚úÖ</div>
                        <div class="stat-content">
                            <span class="stat-number">@compras.Count(c => c.FeedbackRecibido)</span>
                            <span class="stat-label">Procesadas</span>
                        </div>
                    </div>
                </div>

                <!-- Lista de Compras -->
                <div class="purchases-section">
                    <h2 class="section-title">
                        <span class="section-icon">üì¶</span>
                        Historial de Compras
                    </h2>
                    
                    <div class="purchases-grid">
                        @foreach (var compra in compras.OrderByDescending(c => c.FechaCompra))
                        {
                            <div class="purchase-card @GetCardStatusClass(compra)">
                                <div class="purchase-header">
                                    <div class="purchase-title">
                                        <h3>@compra.Nombre</h3>
                                        <span class="purchase-id">#@compra.ID</span>
                                    </div>
                                    <div class="purchase-date">
                                        <span class="date-label">üìÖ</span>
                                        <span class="date-value">@compra.FechaCompra.ToString("dd/MM/yyyy")</span>
                                    </div>
                                </div>

                                @if (!string.IsNullOrEmpty(compra.Descripcion))
                                {
                                    <div class="purchase-description">
                                        <p>@compra.Descripcion</p>
                                    </div>
                                }

                                <div class="purchase-details">
                                    @if (GetEmpleadoNombre(compra) != "No especificado")
                                    {
                                        <div class="detail-item">
                                            <span class="detail-icon">üë§</span>
                                            <span class="detail-label">Vendedor:</span>
                                            <span class="detail-value">@GetEmpleadoNombre(compra)</span>
                                        </div>
                                    }

                                    @if (compra.FechaRecordatorio > DateTime.MinValue)
                                    {
                                        <div class="detail-item">
                                            <span class="detail-icon">üîî</span>
                                            <span class="detail-label">Recordatorio:</span>
                                            <span class="detail-value">@compra.FechaRecordatorio.ToString("dd/MM/yyyy")</span>
                                        </div>
                                    }

                                    @if (!string.IsNullOrEmpty(compra.NotasVentaInternas))
                                    {
                                        <div class="detail-item notes">
                                            <span class="detail-icon">üìù</span>
                                            <span class="detail-label">Notas:</span>
                                            <span class="detail-value">@(compra.NotasVentaInternas.Length > 80 ? compra.NotasVentaInternas.Substring(0, 80) + "..." : compra.NotasVentaInternas)</span>
                                        </div>
                                    }

                                    <div class="detail-item">
                                        <span class="detail-icon">üìÖ</span>
                                        <span class="detail-label">Registrada:</span>
                                        <span class="detail-value">@compra.CreatedAt.ToString("dd/MM/yyyy")</span>
                                    </div>
                                </div>

                                @if (HasValidFeedback(compra))
                                {
                                    <div class="feedback-preview">
                                        <div class="feedback-header">
                                            <span class="feedback-icon">üí≠</span>
                                            <span class="feedback-title">Tu Opini√≥n</span>
                                        </div>
                                        <div class="feedback-content">
                                            <p>@(compra.ComentarioFeedback.Length > 150 ? compra.ComentarioFeedback.Substring(0, 150) + "..." : compra.ComentarioFeedback)</p>
                                        </div>
                                    </div>
                                }

                                <div class="purchase-status">
                                    @if (HasValidFeedback(compra))
                                    {
                                        <span class="status-badge success">
                                            <span class="badge-icon">‚úì</span>
                                            Con Opini√≥n
                                        </span>
                                    }
                                    else
                                    {
                                        <span class="status-badge pending">
                                            <span class="badge-icon">‚óØ</span>
                                            Pendiente Opini√≥n
                                        </span>
                                    }

                                    @if (compra.FeedbackRecibido)
                                    {
                                        <span class="status-badge processed">
                                            <span class="badge-icon">üìã</span>
                                            Procesada
                                        </span>
                                    }
                                </div>

                                <div class="purchase-actions">
                                    @if (HasValidFeedback(compra))
                                    {
                                        <NavLink href="@($"/reviews/edit/{compra.ID}")" class="btn-action edit">
                                            <span class="btn-icon">‚úèÔ∏è</span>
                                            Editar Opini√≥n
                                        </NavLink>
                                        <button type="button" class="btn-action danger" @onclick="@(() => RemoveOpinion(compra.ID))">
                                            <span class="btn-icon">üóëÔ∏è</span>
                                            Borrar Opini√≥n
                                        </button>
                                    }
                                    else
                                    {
                                        <NavLink href="@($"/reviews/create?compraId={compra.ID}")" class="btn-action primary">
                                            <span class="btn-icon">üí¨</span>
                                            Agregar Opini√≥n
                                        </NavLink>
                                        <div class="action-note">
                                            <small>üìù Solo puedes gestionar tus opiniones</small>
                                        </div>
                                    }
                                </div>
                            </div>
                        }
                    </div>
                </div>
            }
            else
            {
                <div class="empty-section">
                    <div class="empty-illustration">
                        <div class="empty-icon">üõí</div>
                        <div class="empty-circles">
                            <div class="circle circle-1"></div>
                            <div class="circle circle-2"></div>
                            <div class="circle circle-3"></div>
                        </div>
                    </div>
                    <h3>No tienes compras registradas</h3>
                    <p>Las compras aparecer√°n aqu√≠ cuando nuestro equipo las registre en el sistema.</p>
                    <p class="empty-note">Si realizaste una compra recientemente, puede tomar unos minutos en aparecer.</p>
                    <div class="empty-actions">
                        <button type="button" class="btn-primary" @onclick="RefreshData">
                            <span class="btn-icon">üîÑ</span>
                            Actualizar Lista
                        </button>
                        <NavLink href="/" class="btn-secondary">
                            <span class="btn-icon">üè†</span>
                            Ir al Inicio
                        </NavLink>
                    </div>
                </div>
            }
        }
    </div>
</div>

@code {
    // Estado de la aplicaci√≥n
    private bool isAuthenticated = false;
    private bool isLoading = false;
    private string errorMessage = "";

    // Datos del usuario y compras
    private Usuario? clienteInfo = null;
    private List<CompraServicio> compras = new();
    private List<Usuario> todosLosUsuarios = new();

    // Informaci√≥n del usuario autenticado
    private string userEmail = "";
    private int clienteID = 0;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            isAuthenticated = await authService.IsUserAuthenticated();
            
            if (!isAuthenticated)
            {
                navigationManager.NavigateTo("/login");
                return;
            }

            await LoadUserData();
        }
        catch (Exception ex)
        {
            HandleError("Error al inicializar la p√°gina", ex);
        }
    }

    private async Task LoadUserData()
    {
        isLoading = true;
        errorMessage = "";
        StateHasChanged();

        try
        {
            // 1. Obtener usuario de Firebase
            var firebaseUser = await authService.GetUserFirebase();
            if (firebaseUser?.Email == null)
            {
                throw new Exception("No se pudo obtener la informaci√≥n de autenticaci√≥n");
            }

            userEmail = firebaseUser.Email;
            Console.WriteLine($"[Compras] Cargando datos para: {userEmail}");

            // 2. Cargar usuarios del sistema
            todosLosUsuarios = await usuarioService.GetAllAsync("") ?? new List<Usuario>();
            Console.WriteLine($"[Compras] Usuarios cargados: {todosLosUsuarios.Count}");

            if (!todosLosUsuarios.Any())
            {
                throw new Exception("No hay usuarios en el sistema");
            }

            // 3. Buscar usuario por email
            var usuario = todosLosUsuarios.FirstOrDefault(u => 
                string.Equals(u.Email, userEmail, StringComparison.OrdinalIgnoreCase));

            if (usuario == null)
            {
                throw new Exception($"Usuario no encontrado para el email: {userEmail}");
            }

            clienteInfo = usuario;
            Console.WriteLine($"[Compras] Usuario encontrado: {usuario.Nombre} (ID: {usuario.ID})");

            // 4. Buscar cliente asociado
            var clientes = await clienteService.GetAllAsync("") ?? new List<Cliente>();
            var cliente = clientes.FirstOrDefault(c => c.UsuarioID == usuario.ID && !c.IsDeleted);

            if (cliente == null)
            {
                throw new Exception("Perfil de cliente no encontrado. Contacta con soporte.");
            }

            clienteID = cliente.ID;
            Console.WriteLine($"[Compras] Cliente encontrado: ID {clienteID}");

            // 5. Cargar compras del cliente
            await LoadPurchases();
        }
        catch (Exception ex)
        {
            HandleError("Error al cargar los datos del usuario", ex);
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private async Task LoadPurchases()
    {
        try
        {
            // Cargar todas las compras
            var todasLasCompras = await compraService.GetAllAsync("") ?? new List<CompraServicio>();
            Console.WriteLine($"[Compras] Total compras en sistema: {todasLasCompras.Count}");

            // Filtrar compras del cliente
            compras = todasLasCompras
                .Where(c => c.ClienteID == clienteID && !c.IsDeleted)
                .ToList();

            Console.WriteLine($"[Compras] Compras del cliente: {compras.Count}");

            // Cargar relaciones de empleados
            foreach (var compra in compras)
            {
                if (compra.EmpleadoID > 0)
                {
                    compra.Empleado = todosLosUsuarios.FirstOrDefault(u => u.ID == compra.EmpleadoID);
                }
            }

            Console.WriteLine($"[Compras] Datos cargados exitosamente");
        }
        catch (Exception ex)
        {
            throw new Exception("Error al cargar el historial de compras", ex);
        }
    }

    private async Task RefreshData()
    {
        await LoadUserData();
    }

    private async Task RemoveOpinion(int compraId)
    {
        if (!await JSRuntime.InvokeAsync<bool>("confirm", 
            "¬øEst√°s seguro de que deseas eliminar tu opini√≥n?\n\nEsta acci√≥n no se puede deshacer."))
        {
            return;
        }

        try
        {
            var compra = compras.FirstOrDefault(c => c.ID == compraId);
            if (compra == null)
            {
                throw new Exception("La compra no fue encontrada");
            }

            Console.WriteLine($"[Compras] Eliminando opini√≥n: {compra.Nombre}");

            // Limpiar feedback y marcar como no recibido
            compra.ComentarioFeedback = string.Empty;
            compra.FeedbackRecibido = false;

            // Actualizar en la base de datos
            bool success = await compraService.UpdateAsync(compra);
            
            if (success)
            {
                // Restaurar el estado de la notificaci√≥n a Pendiente
                await RestaurarNotificacionAPendiente(compraId);

                Console.WriteLine($"[Compras] Opini√≥n eliminada exitosamente");
                StateHasChanged();
            }
            else
            {
                throw new Exception("No se pudo actualizar la compra");
            }
        }
        catch (Exception ex)
        {
            HandleError("Error al eliminar la opini√≥n", ex);
        }
    }

    private async Task RestaurarNotificacionAPendiente(int compraServicioID)
    {
        try
        {
            Console.WriteLine($"[Compras] Restaurando notificaci√≥n para CompraServicioID: {compraServicioID}");

            // Obtener todas las notificaciones
            var todasLasNotificaciones = await notificacionService.GetAllAsync("") ?? new List<Notificacion>();

            // Buscar la notificaci√≥n espec√≠fica para esta compra
            var notificacion = todasLasNotificaciones.FirstOrDefault(n => 
                n.CompraServicioID == compraServicioID && 
                !n.IsDeleted);

            if (notificacion != null)
            {
                Console.WriteLine($"[Compras] Encontrada notificaci√≥n ID: {notificacion.ID}, estado actual: {notificacion.Estado}");

                // Cambiar el estado de vuelta a Pendiente
                notificacion.Estado = EstadoNotificacion.Pendiente;

                // Actualizar la notificaci√≥n
                bool notificacionActualizada = await notificacionService.UpdateAsync(notificacion);

                if (notificacionActualizada)
                {
                    Console.WriteLine($"[Compras] Notificaci√≥n restaurada a estado Pendiente exitosamente");
                }
                else
                {
                    Console.WriteLine($"[Compras] Warning: No se pudo restaurar la notificaci√≥n");
                }
            }
            else
            {
                Console.WriteLine($"[Compras] No se encontr√≥ notificaci√≥n para CompraServicioID: {compraServicioID}");
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"[Compras] Error al restaurar notificaci√≥n: {ex.Message}");
            // No lanzamos la excepci√≥n para no afectar el flujo principal
        }
    }

    private void HandleError(string context, Exception ex)
    {
        errorMessage = $"{context}: {ex.Message}";
        Console.WriteLine($"[Compras] {context}: {ex}");
    }

    private string GetEmpleadoNombre(CompraServicio compra)
    {
        if (compra.Empleado?.Nombre != null)
            return compra.Empleado.Nombre;

        if (compra.EmpleadoID > 0)
        {
            var empleado = todosLosUsuarios?.FirstOrDefault(u => u.ID == compra.EmpleadoID);
            return empleado?.Nombre ?? $"Empleado #{compra.EmpleadoID}";
        }

        return "No especificado";
    }

    private bool HasValidFeedback(CompraServicio compra)
    {
        return !string.IsNullOrWhiteSpace(compra.ComentarioFeedback);
    }

    private string GetCardStatusClass(CompraServicio compra)
    {
        if (HasValidFeedback(compra))
            return "has-opinion";
        return "needs-opinion";
    }

    [Inject] private IJSRuntime JSRuntime { get; set; } = null!; // Inyecci√≥n de IJSRuntime para confirmaciones 
}
