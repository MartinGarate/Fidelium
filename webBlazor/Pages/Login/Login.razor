@page "/login"

@inject FirebaseAuthService authService
@inject NavigationManager navigationManager
@inject IGenericService<Usuario> usuarioService
@inject IGenericService<Cliente> clienteService

@using Service.Enums
@using Service.Models

@if (!isAuthenticated)
{
    <div class="login-container">
        <div class="login-card">
            <!-- Header -->
            <div class="login-header">
                <h1 class="login-title">Bienvenido</h1>
                <p class="login-subtitle">Inicia sesión en tu cuenta</p>
            </div>

            <!-- Tabs Navigation -->
            <div class="login-tabs">
                <button class="tab-button @(isLoginTab ? "active" : "")" @onclick="() => isLoginTab = true">
                    Iniciar Sesión
                </button>
                <button class="tab-button @(!isLoginTab ? "active" : "")" @onclick="() => isLoginTab = false">
                    Registrarse
                </button>
            </div>

            <!-- Error Message -->
            @if (!string.IsNullOrEmpty(errorMessage))
            {
                <div class="error-alert">
                    <span class="error-icon">⚠️</span>
                    <span>@errorMessage</span>
                </div>
            }

            <!-- Success Message -->
            @if (!string.IsNullOrEmpty(successMessage))
            {
                <div class="success-alert">
                    <span class="success-icon">✓</span>
                    <span>@successMessage</span>
                </div>
            }

            <!-- Login Form -->
            @if (isLoginTab)
            {
                <form @onsubmit="Loguear" class="login-form">
                    <div class="form-group">
                        <label for="login-email" class="form-label">Correo Electrónico</label>
                        <input id="login-email"
                               type="email"
                               class="form-input"
                               @bind="email"
                               placeholder="tu@email.com"
                               required />
                    </div>

                    <div class="form-group">
                        <label for="login-password" class="form-label">Contraseña</label>
                        <input id="login-password"
                               type="password"
                               class="form-input"
                               @bind="password"
                               placeholder="••••••••"
                               required />
                    </div>

                    <div class="form-remember">
                        <label class="checkbox-label">
                            <input type="checkbox" @bind="rememberPassword" />
                            <span>Recuérdame</span>
                        </label>
                    </div>

                    <button type="submit" class="btn-login-submit" disabled="@isLoading">
                        @if (isLoading)
                        {
                            <span class="spinner"></span>
                            <span>Iniciando sesión...</span>
                        }
                        else
                        {
                            <span>Iniciar Sesión</span>
                        }
                    </button>
                </form>

                <!-- Google Login -->
                <div class="divider">
                    <span>O continúa con</span>
                </div>
                <button class="btn-google" @onclick="LoginWithGoogle" disabled="@isLoading">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor" class="icon icon-tabler icons-tabler-filled icon-tabler-brand-google"><path stroke="none" d="M0 0h24v24H0z" fill="none" /><path d="M12 2a9.96 9.96 0 0 1 6.29 2.226a1 1 0 0 1 .04 1.52l-1.51 1.362a1 1 0 0 1 -1.265 .06a6 6 0 1 0 2.103 6.836l.001 -.004h-3.66a1 1 0 0 1 -.992 -.883l-.007 -.117v-2a1 1 0 0 1 1 -1h6.945a1 1 0 0 1 .994 .89c.04 .367 .061 .737 .061 1.11c0 5.523 -4.477 10 -10 10s-10 -4.477 -10 -10s4.477 -10 10 -10z" /></svg>
                    Google
                </button>
            }

            <!-- Register Form -->
            @if (!isLoginTab)
            {
                <form @onsubmit="RegisterMe" class="login-form">
                    <div class="form-group">
                        <label for="register-name" class="form-label">Nombre Completo</label>
                        <input id="register-name"
                               type="text"
                               class="form-input"
                               @bind="registerName"
                               placeholder="Tu nombre"
                               required />
                    </div>

                    <div class="form-group">
                        <label for="register-dni" class="form-label">DNI</label>
                        <input id="register-dni"
                               type="text"
                               class="form-input"
                               @bind="registerDNI"
                               placeholder="Ej: 12345678 o X1234567L"
                               required />
                    </div>

                    <div class="form-group">
                        <label for="register-email" class="form-label">Correo Electrónico</label>
                        <input id="register-email"
                               type="email"
                               class="form-input"
                               @bind="registerEmail"
                               placeholder="tu@email.com"
                               required />
                    </div>

                    <div class="form-group">
                        <label for="register-password" class="form-label">Contraseña</label>
                        <input id="register-password"
                               type="password"
                               class="form-input"
                               @bind="registerPassword"
                               placeholder="Mínimo 6 caracteres"
                               required />
                    </div>

                    <div class="form-group">
                        <label for="register-confirm" class="form-label">Confirmar Contraseña</label>
                        <input id="register-confirm"
                               type="password"
                               class="form-input"
                               @bind="registerConfirmPassword"
                               placeholder="Confirma tu contraseña"
                               required />
                    </div>

                    <div class="form-group">
                        <label for="register-phone" class="form-label">Teléfono (Opcional)</label>
                        <input id="register-phone"
                               type="tel"
                               class="form-input"
                               @bind="registerPhone"
                               placeholder="+34 123 456 789" />
                    </div>

                    <div class="form-group">
                        <label for="register-instagram" class="form-label">Instagram (Opcional)</label>
                        <input id="register-instagram"
                               type="text"
                               class="form-input"
                               @bind="registerInstagram"
                               placeholder="tu_usuario" />
                    </div>

                    <label class="checkbox-label full-width">
                        <input type="checkbox" @bind="agreeTerms" required />
                        <span>Acepto los términos y condiciones</span>
                    </label>

                    <button type="submit" class="btn-login-submit" disabled="@isLoading">
                        @if (isLoading)
                        {
                            <span class="spinner"></span>
                            <span>Registrando...</span>
                        }
                        else
                        {
                            <span>Crear Cuenta</span>
                        }
                    </button>
                </form>

                <!-- Google Register -->
                <div class="divider">
                    <span>O regístrate con</span>
                </div>
                <button class="btn-google" @onclick="LoginWithGoogle" disabled="@isLoading">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor" class="icon icon-tabler icons-tabler-filled icon-tabler-brand-google"><path stroke="none" d="M0 0h24v24H0z" fill="none" /><path d="M12 2a9.96 9.96 0 0 1 6.29 2.226a1 1 0 0 1 .04 1.52l-1.51 1.362a1 1 0 0 1 -1.265 .06a6 6 0 1 0 2.103 6.836l.001 -.004h-3.66a1 1 0 0 1 -.992 -.883l-.007 -.117v-2a1 1 0 0 1 1 -1h6.945a1 1 0 0 1 .994 .89c.04 .367 .061 .737 .061 1.11c0 5.523 -4.477 10 -10 10s-10 -4.477 -10 -10s4.477 -10 10 -10z" /></svg>
                    Google
                </button>
            }

            <!-- Footer -->
            <div class="login-footer">
                @if (isLoginTab)
                {
                    <p>¿No tienes cuenta? <button type="button" class="link-button" @onclick="() => isLoginTab = false">Regístrate aquí</button></p>
                }
                else
                {
                    <p>¿Ya tienes cuenta? <button type="button" class="link-button" @onclick="() => isLoginTab = true">Inicia sesión</button></p>
                }
            </div>
        </div>

        <!-- Background Decoration -->
        <div class="login-bg-decoration"></div>
    </div>
}
else
{
    <div class="login-container">
        <div class="login-card">
            <div class="login-header">
                <h1 class="login-title">Cerrar sesión</h1>
                <p class="login-subtitle">Eres @userDisplayName</p>
            </div>

            <div style="text-align: center; margin: 30px 0;">
                <p style="color: #a8a8a8; margin-bottom: 20px;">¿Deseas cerrar sesión?</p>
                <button class="btn-login-submit" @onclick="Desloguear">
                    Cerrar Sesión
                </button>
            </div>
        </div>
        <div class="login-bg-decoration"></div>
    </div>
}

@code {
    private bool isAuthenticated = false;
    private string userDisplayName = "Usuario";
    private bool isLoginTab = true;
    private bool isLoading = false;
    private string errorMessage = "";
    private string successMessage = "";

    // Login fields
    private string email = "";
    private string password = "";
    private bool rememberPassword = false;

    // Register fields
    private string registerName = "";
    private string registerDNI = "";
    private string registerEmail = "";
    private string registerPassword = "";
    private string registerConfirmPassword = "";
    private string registerPhone = "";
    private string registerInstagram = "";
    private bool agreeTerms = false;


    protected override async Task OnInitializedAsync()
    {
        isAuthenticated = await authService.IsUserAuthenticated();
        if (isAuthenticated)
        {
            userDisplayName = await authService.GetUserDisplayName() ?? "Usuario";
        }
    }

    private async Task Loguear()
    {
        errorMessage = "";
        successMessage = "";

        if (string.IsNullOrWhiteSpace(email) || string.IsNullOrWhiteSpace(password))
        {
            errorMessage = "Por favor completa todos los campos";
            return;
        }

        isLoading = true;

        try
        {
            var user = await authService.SignInWithEmailPassword(email, password, rememberPassword);

            if (user != null)
            {
                if (!user.EmailVerified)
                {
                    errorMessage = "Por favor, verifica tu correo electrónico antes de iniciar sesión.";
                    isLoading = false;
                    return;
                }

                isAuthenticated = true;
                userDisplayName = user.DisplayName ?? "Usuario";
                successMessage = "¡Iniciaste sesión correctamente!";

                // Esperar un poco para que el evento se propague
                await Task.Delay(500);
                navigationManager.NavigateTo("/");
            }
            else
            {
                errorMessage = "Correo o contraseña incorrectos.";
                isLoading = false;
            }
        }
        catch (Exception ex)
        {
            errorMessage = "Error al iniciar sesión: " + ex.Message;
            isLoading = false;
        }
    }

    private async Task RegisterMe()
    {
        errorMessage = "";
        successMessage = "";

        if (string.IsNullOrWhiteSpace(registerEmail) ||
            string.IsNullOrWhiteSpace(registerPassword) ||
            string.IsNullOrWhiteSpace(registerName) ||
            string.IsNullOrWhiteSpace(registerDNI))
        {
            errorMessage = "Por favor completa todos los campos obligatorios (Nombre, DNI, Email, Contraseña)";
            return;
        }

        if (registerPassword != registerConfirmPassword)
        {
            errorMessage = "Las contraseñas no coinciden";
            return;
        }

        if (registerPassword.Length < 6)
        {
            errorMessage = "La contraseña debe tener mínimo 6 caracteres";
            return;
        }

        if (!agreeTerms)
        {
            errorMessage = "Debes aceptar los términos y condiciones";
            return;
        }

        // Validar formato del DNI
        if (!IsValidDNI(registerDNI))
        {
            errorMessage = "El formato del DNI no es válido";
            return;
        }

        // Verificar que el DNI no esté duplicado
        var dniExists = await CheckDNIExists(registerDNI);
        if (dniExists)
        {
            errorMessage = "El DNI ingresado ya está registrado en el sistema";
            return;
        }

        isLoading = true;

        try
        {
            // 1. Crear usuario en Firebase
            var userId = await authService.createUserWithEmailAndPassword(registerEmail, registerPassword, registerName);

            if (!string.IsNullOrEmpty(userId))
            {
                // 2. Crear usuario en la BD SQL usando el servicio genérico
                var usuarioResponse = await CreateUsuarioInDatabase(registerName, registerDNI, registerEmail);

                if (usuarioResponse != null && usuarioResponse.ID > 0)
                {
                    // 3. Crear cliente en la BD SQL asociado al usuario
                    await CreateClienteInDatabase(usuarioResponse.ID);

                    successMessage = "¡Cuenta creada correctamente! Inicia sesión con tus credenciales";
                    isLoginTab = true;
                    // Limpiar campos del formulario
                    ClearRegisterFields();
                    await Task.Delay(2000);
                    StateHasChanged();
                }
                else
                {
                    errorMessage = "Error al registrar en la base de datos";
                }
            }
            else
            {
                errorMessage = "Error al crear la cuenta en Firebase";
            }
        }
        catch (Exception ex)
        {
            errorMessage = "Error al registrarse: " + ex.Message;
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task<Usuario?> CreateUsuarioInDatabase(string nombre, string dni, string email)
    {
        try
        {
            var usuario = new Usuario
            {
                Nombre = nombre,
                DNI = dni,
                Email = email,
                TipoUsuario = TipoUsuarioEnum.Cliente
            };

            return await usuarioService.AddAsync(usuario);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error al crear usuario: {ex.Message}");
            throw;
        }
    }

    private bool IsValidDNI(string dni)
    {
        if (string.IsNullOrWhiteSpace(dni))
            return false;

        // Eliminar espacios y puntos
        var cleanDni = dni.Trim().Replace(" ", "").Replace(".", "");

        // Verificar longitud mínima y máxima
        if (cleanDni.Length < 5 || cleanDni.Length > 20)
            return false;

        // Permitir números, letras y guiones (para diferentes formatos de DNI/NIE/Pasaporte)
        return cleanDni.All(c => char.IsLetterOrDigit(c) || c == '-');
    }

    private async Task<bool> CheckDNIExists(string dni)
    {
        try
        {
            var usuarios = await usuarioService.GetAllAsync("") ?? new List<Usuario>();
            return usuarios.Any(u => string.Equals(u.DNI, dni, StringComparison.OrdinalIgnoreCase));
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error al verificar DNI: {ex.Message}");
            return false; // En caso de error, permitir continuar
        }
    }

    private async Task CreateClienteInDatabase(int usuarioID)
    {
        try
        {
            var cliente = new Cliente
            {
                UsuarioID = usuarioID,
                Telefono = string.IsNullOrWhiteSpace(registerPhone) ? string.Empty : registerPhone,
                Instagram = string.IsNullOrWhiteSpace(registerInstagram) ? string.Empty : registerInstagram
            };

            await clienteService.AddAsync(cliente);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error al crear cliente: {ex.Message}");
            throw;
        }
    }

    private async Task LoginWithGoogle()
    {
        errorMessage = "";
        isLoading = true;

        try
        {
            var user = await authService.LoginWithGoogle();

            if (user != null)
            {
                // Verificar si existe usuario en BD, si no, crear uno
                await EnsureUserExistsInDatabase(user.Email, user.DisplayName);

                isAuthenticated = true;
                userDisplayName = user.DisplayName ?? "Usuario";
                successMessage = "¡Iniciaste sesión con Google!";

                // Esperar un poco para que el evento se propague
                await Task.Delay(500);
                navigationManager.NavigateTo("/");
            }
            else
            {
                errorMessage = "No se pudo iniciar sesión con Google.";
                isLoading = false;
            }
        }
        catch (Exception ex)
        {
            errorMessage = "Error al iniciar sesión con Google: " + ex.Message;
            isLoading = false;
        }
    }

    private async Task EnsureUserExistsInDatabase(string email, string displayName)
    {
        try
        {
            // Buscar si el usuario ya existe usando el servicio genérico
            var usuarios = await usuarioService.GetAllAsync("");
            var usuarioExistente = usuarios?.FirstOrDefault(u => u.Email == email);

            if (usuarioExistente == null)
            {
                // Generar un DNI temporal para usuarios de Google (puede ser cambiado después)
                var dniTemporal = $"GOOGLE_{DateTime.Now:yyyyMMddHHmmss}";
                
                // Crear nuevo usuario
                var nuevoUsuario = new Usuario
                {
                    Nombre = displayName ?? "Usuario",
                    DNI = dniTemporal,
                    Email = email,
                    TipoUsuario = TipoUsuarioEnum.Cliente
                };

                var usuarioCreado = await usuarioService.AddAsync(nuevoUsuario);

                // Crear cliente para el nuevo usuario
                if (usuarioCreado?.ID > 0)
                {
                    var nuevoCliente = new Cliente
                    {
                        UsuarioID = usuarioCreado.ID,
                        Telefono = string.Empty,
                        Instagram = string.Empty
                    };

                    await clienteService.AddAsync(nuevoCliente);
                }
            }
            else
            {
                // Verificar si tiene cliente asociado
                await EnsureClienteExists(usuarioExistente.ID);
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error al asegurar usuario en BD: {ex.Message}");
            throw;
        }
    }

    private async Task EnsureClienteExists(int usuarioID)
    {
        try
        {
            // Obtener todos los clientes y buscar el asociado al usuario
            var clientes = await clienteService.GetAllAsync("");
            var clienteExistente = clientes?.FirstOrDefault(c => c.UsuarioID == usuarioID);

            if (clienteExistente == null)
            {
                // Crear cliente si no existe
                var nuevoCliente = new Cliente
                {
                    UsuarioID = usuarioID,
                    Telefono = string.Empty,
                    Instagram = string.Empty
                };

                await clienteService.AddAsync(nuevoCliente);
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error al asegurar cliente: {ex.Message}");
            throw;
        }
    }

    private async Task Desloguear()
    {
        isLoading = true;
        try
        {
            email = string.Empty;
            password = string.Empty;
            isAuthenticated = false;
            userDisplayName = "Usuario";
            await authService.SignOut();
            StateHasChanged();
        }
        finally
        {
            isLoading = false;
        }
    }

    private void ClearRegisterFields()
    {
        registerName = "";
        registerDNI = "";
        registerEmail = "";
        registerPassword = "";
        registerConfirmPassword = "";
        registerPhone = "";
        registerInstagram = "";
        agreeTerms = false;
    }
}

