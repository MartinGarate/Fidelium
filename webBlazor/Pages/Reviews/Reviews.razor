@page "/reviews"
@inject FirebaseAuthService authService
@inject NavigationManager navigationManager
@inject IGenericService<Usuario> usuarioService
@inject IGenericService<Cliente> clienteService
@inject IGenericService<CompraServicio> compraService

<div class="reviews-container">
    <div class="reviews-card">
        @if (!isAuthenticated)
        {
            <div class="access-denied">
                <div class="access-denied-icon">🔐</div>
                <h2>Acceso Restringido</h2>
                <p>Inicia sesión para gestionar tus opiniones sobre compras y servicios.</p>
                <NavLink href="/login" class="btn-primary">
                    🚀 Iniciar Sesión
                </NavLink>
            </div>
        }
        else
        {
            <div class="reviews-header">
                <div class="header-content">
                    <h1 class="page-title">
                        <span class="title-icon">💬</span>
                        Mis Opiniones
                    </h1>
                    <p class="page-subtitle">Gestiona tus comentarios y experiencias sobre compras y servicios</p>
                    @if (clienteInfo != null && opiniones.Count > 0)
                    {
                        <div class="client-info">
                            <span class="client-badge">👤 {clienteInfo.Nombre}</span>
                            <span class="opinions-count">💭 {opiniones.Count} opiniones</span>
                        </div>
                    }
                </div>
                <div class="header-actions">
                    <NavLink href="/reviews/create" class="btn-create">
                        ➕ Nueva Opinión
                    </NavLink>
                    <NavLink href="/compras" class="btn-back">
                        📦 Ver Compras
                    </NavLink>
                    <button type="button" class="btn-refresh" @onclick="RefreshData" disabled="@isLoading">
                        @if (isLoading)
                        {
                            <span class="spinner-small"></span>
                        }
                        else
                        {
                            <span>🔄</span>
                        }
                        Actualizar
                    </button>
                </div>
            </div>

            @if (!string.IsNullOrEmpty(errorMessage))
            {
                <div class="error-section">
                    <div class="error-alert">
                        <span class="error-icon">⚠️</span>
                        <div class="error-content">
                            <strong>Error</strong>
                            <p>@errorMessage</p>
                        </div>
                        <button class="btn-retry" @onclick="RefreshData">
                            Reintentar
                        </button>
                    </div>
                </div>
            }

            @if (isLoading)
            {
                <div class="loading-section">
                    <div class="loading-spinner">
                        <div class="spinner-ring"></div>
                        <div class="spinner-ring spinner-ring-2"></div>
                        <div class="spinner-ring spinner-ring-3"></div>
                    </div>
                    <h3>Cargando opiniones...</h3>
                    <p>Obteniendo tus comentarios y reseñas</p>
                </div>
            }
            else if (opiniones.Any())
            {
                <!-- Estadísticas -->
                <div class="stats-section">
                    <div class="stat-card primary">
                        <div class="stat-icon">💬</div>
                        <div class="stat-content">
                            <span class="stat-number">@opiniones.Count</span>
                            <span class="stat-label">Total Opiniones</span>
                        </div>
                    </div>
                    <div class="stat-card success">
                        <div class="stat-icon">📝</div>
                        <div class="stat-content">
                            <span class="stat-number">@opiniones.Count(o => o.ComentarioFeedback.Length > 50)</span>
                            <span class="stat-label">Detalladas</span>
                        </div>
                    </div>
                    <div class="stat-card info">
                        <div class="stat-icon">⭐</div>
                        <div class="stat-content">
                            <span class="stat-number">@opiniones.Count(o => o.FeedbackRecibido)</span>
                            <span class="stat-label">Procesadas</span>
                        </div>
                    </div>
                    <div class="stat-card warning">
                        <div class="stat-icon">📅</div>
                        <div class="stat-content">
                            <span class="stat-number">@GetRecentOpinionsCount()</span>
                            <span class="stat-label">Este Mes</span>
                        </div>
                    </div>
                </div>

                <!-- Lista de Opiniones -->
                <div class="opinions-section">
                    <h2 class="section-title">
                        <span class="section-icon">💭</span>
                        Tus Comentarios y Reseñas
                    </h2>
                    
                    <div class="opinions-grid">
                        @foreach (var opinion in opiniones.OrderByDescending(o => o.CreatedAt))
                        {
                            <div class="opinion-card @GetOpinionCardClass(opinion)">
                                <div class="opinion-header">
                                    <div class="opinion-title">
                                        <h3>@opinion.Nombre</h3>
                                        <span class="opinion-id">#@opinion.ID</span>
                                    </div>
                                    <div class="opinion-status">
                                        @if (opinion.FeedbackRecibido)
                                        {
                                            <span class="status-badge processed">
                                                <span class="badge-icon">✅</span>
                                                Procesada
                                            </span>
                                        }
                                        else
                                        {
                                            <span class="status-badge pending">
                                                <span class="badge-icon">⏳</span>
                                                Pendiente
                                            </span>
                                        }
                                    </div>
                                </div>

                                @if (!string.IsNullOrEmpty(opinion.Descripcion))
                                {
                                    <div class="opinion-description">
                                        <span class="description-label">📝 Producto/Servicio:</span>
                                        <p>@opinion.Descripcion</p>
                                    </div>
                                }

                                <div class="opinion-content">
                                    <div class="content-header">
                                        <span class="content-icon">💭</span>
                                        <span class="content-title">Tu Opinión</span>
                                        <span class="content-length">@opinion.ComentarioFeedback.Length caracteres</span>
                                    </div>
                                    <div class="content-text">
                                        <p>@opinion.ComentarioFeedback</p>
                                    </div>
                                </div>

                                <div class="opinion-meta">
                                    <div class="meta-item">
                                        <span class="meta-icon">📅</span>
                                        <span class="meta-label">Compra:</span>
                                        <span class="meta-value">@opinion.FechaCompra.ToString("dd/MM/yyyy")</span>
                                    </div>
                                    <div class="meta-item">
                                        <span class="meta-icon">✍️</span>
                                        <span class="meta-label">Opinión:</span>
                                        <span class="meta-value">@opinion.CreatedAt.ToString("dd/MM/yyyy HH:mm")</span>
                                    </div>
                                    @if (opinion.FechaRecordatorio > DateTime.MinValue)
                                    {
                                        <div class="meta-item">
                                            <span class="meta-icon">🔔</span>
                                            <span class="meta-label">Recordatorio:</span>
                                            <span class="meta-value">@opinion.FechaRecordatorio.ToString("dd/MM/yyyy")</span>
                                        </div>
                                    }
                                </div>

                                <div class="opinion-actions">
                                    <NavLink href="@($"/reviews/edit/{opinion.ID}")" class="btn-action edit">
                                        <span class="btn-icon">✏️</span>
                                        Editar
                                    </NavLink>
                                    <button type="button" class="btn-action danger" @onclick="@(() => DeleteOpinion(opinion.ID))">
                                        <span class="btn-icon">🗑️</span>
                                        Eliminar
                                    </button>
                                    <NavLink href="@($"/compras")" class="btn-action secondary">
                                        <span class="btn-icon">📦</span>
                                        Ver Compra
                                    </NavLink>
                                </div>
                            </div>
                        }
                    </div>
                </div>
            }
            else
            {
                <div class="empty-section">
                    <div class="empty-illustration">
                        <div class="empty-icon">💭</div>
                        <div class="empty-bubbles">
                            <div class="bubble bubble-1"></div>
                            <div class="bubble bubble-2"></div>
                            <div class="bubble bubble-3"></div>
                        </div>
                    </div>
                    <h3>Aún no tienes opiniones</h3>
                    <p>Comparte tu experiencia sobre tus compras y servicios para ayudar a mejorar nuestro servicio.</p>
                    <p class="empty-note">Las opiniones que escribas nos ayudan a brindarte un mejor servicio personalizado.</p>
                    <div class="empty-actions">
                        <NavLink href="/reviews/create" class="btn-primary">
                            <span class="btn-icon">💬</span>
                            Crear Primera Opinión
                        </NavLink>
                        <NavLink href="/compras" class="btn-secondary">
                            <span class="btn-icon">📦</span>
                            Ver Mis Compras
                        </NavLink>
                        <button type="button" class="btn-tertiary" @onclick="RefreshData">
                            <span class="btn-icon">🔄</span>
                            Actualizar Lista
                        </button>
                    </div>
                </div>
            }
        }
    </div>
</div>

@code {
    // Estado de la aplicación
    private bool isAuthenticated = false;
    private bool isLoading = false;
    private string errorMessage = "";

    // Datos del usuario y opiniones
    private Usuario? clienteInfo = null;
    private List<CompraServicio> opiniones = new();
    
    // Información del usuario autenticado
    private string userEmail = "";
    private int clienteID = 0;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            isAuthenticated = await authService.IsUserAuthenticated();
            
            if (!isAuthenticated)
            {
                navigationManager.NavigateTo("/login");
                return;
            }

            await LoadUserOpinions();
        }
        catch (Exception ex)
        {
            HandleError("Error al inicializar la página", ex);
        }
    }

    private async Task LoadUserOpinions()
    {
        isLoading = true;
        errorMessage = "";
        StateHasChanged();

        try
        {
            // 1. Obtener usuario de Firebase
            var firebaseUser = await authService.GetUserFirebase();
            if (firebaseUser?.Email == null)
            {
                throw new Exception("No se pudo obtener la información de autenticación");
            }

            userEmail = firebaseUser.Email;
            Console.WriteLine($"[Reviews] Cargando opiniones para: {userEmail}");

            // 2. Cargar usuarios del sistema
            var todosLosUsuarios = await usuarioService.GetAllAsync("") ?? new List<Usuario>();
            Console.WriteLine($"[Reviews] Usuarios cargados: {todosLosUsuarios.Count}");

            if (!todosLosUsuarios.Any())
            {
                throw new Exception("No hay usuarios en el sistema");
            }

            // 3. Buscar usuario por email
            var usuario = todosLosUsuarios.FirstOrDefault(u => 
                string.Equals(u.Email, userEmail, StringComparison.OrdinalIgnoreCase));

            if (usuario == null)
            {
                throw new Exception($"Usuario no encontrado para el email: {userEmail}");
            }

            clienteInfo = usuario;
            Console.WriteLine($"[Reviews] Usuario encontrado: {usuario.Nombre} (ID: {usuario.ID})");

            // 4. Buscar cliente asociado
            var clientes = await clienteService.GetAllAsync("") ?? new List<Cliente>();
            var cliente = clientes.FirstOrDefault(c => c.UsuarioID == usuario.ID && !c.IsDeleted);

            if (cliente == null)
            {
                throw new Exception("Perfil de cliente no encontrado. Contacta con soporte.");
            }

            clienteID = cliente.ID;
            Console.WriteLine($"[Reviews] Cliente encontrado: ID {clienteID}");

            // 5. Cargar opiniones del cliente
            await LoadOpinions();
        }
        catch (Exception ex)
        {
            HandleError("Error al cargar las opiniones", ex);
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private async Task LoadOpinions()
    {
        try
        {
            // Cargar todas las compras
            var todasLasCompras = await compraService.GetAllAsync("") ?? new List<CompraServicio>();
            Console.WriteLine($"[Reviews] Total compras en sistema: {todasLasCompras.Count}");

            // Filtrar solo las que tienen opiniones del cliente
            opiniones = todasLasCompras
                .Where(c => c.ClienteID == clienteID && 
                           !c.IsDeleted && 
                           !string.IsNullOrWhiteSpace(c.ComentarioFeedback))
                .ToList();

            Console.WriteLine($"[Reviews] Opiniones del cliente: {opiniones.Count}");
        }
        catch (Exception ex)
        {
            throw new Exception("Error al cargar las opiniones", ex);
        }
    }

    private async Task RefreshData()
    {
        await LoadUserOpinions();
    }

    private async Task DeleteOpinion(int compraId)
    {
        if (!await JSRuntime.InvokeAsync<bool>("confirm", 
            "¿Estás seguro de que deseas eliminar esta opinión?\n\nEsta acción limpiará tu comentario pero mantendrá el registro de compra."))
        {
            return;
        }

        try
        {
            var compra = opiniones.FirstOrDefault(c => c.ID == compraId);
            if (compra == null)
            {
                throw new Exception("La opinión no fue encontrada");
            }

            Console.WriteLine($"[Reviews] Eliminando opinión: {compra.Nombre}");

            // Limpiar feedback
            compra.ComentarioFeedback = string.Empty;
            compra.FeedbackRecibido = false;

            // Actualizar en la base de datos
            bool success = await compraService.UpdateAsync(compra);
            
            if (success)
            {
                // Remover de la lista local
                opiniones.RemoveAll(o => o.ID == compraId);
                Console.WriteLine($"[Reviews] Opinión eliminada exitosamente");
                StateHasChanged();
            }
            else
            {
                throw new Exception("No se pudo actualizar la compra");
            }
        }
        catch (Exception ex)
        {
            HandleError("Error al eliminar la opinión", ex);
        }
    }

    private void HandleError(string context, Exception ex)
    {
        errorMessage = $"{context}: {ex.Message}";
        Console.WriteLine($"[Reviews] {context}: {ex}");
    }

    private string GetOpinionCardClass(CompraServicio opinion)
    {
        if (opinion.FeedbackRecibido)
            return "processed";
        
        if (opinion.ComentarioFeedback.Length > 100)
            return "detailed";
            
        return "standard";
    }

    private int GetRecentOpinionsCount()
    {
        var oneMonthAgo = DateTime.Now.AddMonths(-1);
        return opiniones.Count(o => o.CreatedAt >= oneMonthAgo);
    }

    [Inject] private IJSRuntime JSRuntime { get; set; } = null!;
}
